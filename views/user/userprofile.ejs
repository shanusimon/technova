<%- include('../partials/user/header') %>

<main class="container py-5">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="index.html">Home</a></li>
      <li class="breadcrumb-item">Pages</li>
      <li class="breadcrumb-item active" aria-current="page">Account</li>
    </ol>
  </nav>

  <div class="row">
    <div class="col-lg-3">
      <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
        <button class="nav-link active" id="dashboard-tab" data-bs-toggle="pill" data-bs-target="#dashboard" type="button" role="tab" aria-controls="dashboard" aria-selected="true">
          <i class="bi bi-gear me-2"></i>Dashboard
        </button>
        <button class="nav-link" id="orders-tab" data-bs-toggle="pill" data-bs-target="#orders" type="button" role="tab" aria-controls="orders" aria-selected="false">
          <i class="bi bi-bag me-2"></i>Orders
        </button>
        <button class="nav-link" id="track-orders-tab" data-bs-toggle="pill" data-bs-target="#track-orders" type="button" role="tab" aria-controls="track-orders" aria-selected="false">
          <i class="bi bi-truck me-2"></i>Track Your Order
        </button>
        <button class="nav-link" id="address-tab" data-bs-toggle="pill" data-bs-target="#address" type="button" role="tab" aria-controls="address" aria-selected="false">
          <i class="bi bi-geo-alt me-2"></i>My Address
        </button>
        <button class="nav-link" id="account-detail-tab" data-bs-toggle="pill" data-bs-target="#account-detail" type="button" role="tab" aria-controls="account-detail" aria-selected="false">
          <i class="bi bi-person me-2"></i>Account details
        </button>
        <a class="nav-link" href="/logout">
          <i class="bi bi-box-arrow-right me-2"></i>Logout
        </a>
      </div>
    </div>
    <div class="col-lg-9">
      <div class="tab-content" id="v-pills-tabContent">
        <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Hello <%= user.username %></h5>
            </div>
            <div class="card-body">
              <p class="card-text">From your account dashboard. you can easily check & view your <a href="#">recent orders</a>, manage your <a href="#">shipping and billing address</a> and <a href="#">edit your password and account details.</a></p>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Your Orders</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Order ID</th>
                      <th>Date</th>
                      <th>Status</th>
                      <th>Total</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% if (orders && orders.length > 0) { %>
                      <% orders.forEach(order => { %>
                        <tr>
                          <td>#<%= order.orderId %></td>
                          <td><%= new Date(order.createdOn).toLocaleDateString() %></td>
                          <td><%= order.status %></td>
                          <td>â‚¹<%= order.finalAmount %> for <%= order.orderedItems.length %> item(s)</td>
                          <td>
                            <a href="/order-details?id=<%= order._id %>" class="btn btn-sm btn-primary">View</a>
                            <% if (order.status !== "Cancelled" && order.status !== "Delivered") { %>
                                <button class="btn btn-sm btn-danger" onclick="confirmCancelation('<%= order._id %>', '<%= order.paymentMethod %>')">Cancel Order</button>
                              <% } else if (order.status === "Delivered") { %>
                                <button class="btn btn-sm btn-danger" onclick="confirmReturn('<%= order._id %>', '<%= order.paymentMethod %>')">Return Order</button>
                              <% } %>                              
                          </td>
                        </tr>
                      <% }); %>
                    <% } else { %>
                      <tr>
                        <td colspan="5" class="text-center">No orders found</td>
                      </tr>
                    <% } %>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Orders tracking</h5>
            </div>
            <div class="card-body">
              <p class="card-text">To track your order please enter your OrderID in the box below and press "Track" button. This was given to you on your receipt and in the confirmation email you should have received.</p>
              <form class="mt-4" action="#" method="post">
                <div class="mb-3">
                  <label for="order-id" class="form-label">Order ID</label>
                  <input type="text" class="form-control" id="order-id" name="order-id" placeholder="Found in your order confirmation email">
                </div>
                <div class="mb-3">
                  <label for="billing-email" class="form-label">Billing email</label>
                  <input type="email" class="form-control" id="billing-email" name="billing-email" placeholder="Email you used during checkout">
                </div>
                <button type="submit" class="btn btn-primary">Track</button>
              </form>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
          <div class="row">
            <% if (addresses && addresses.length > 0) { %>
              <% addresses.forEach(address => { %>
                <div class="col-md-6 mb-3">
                  <div class="card">
                    <div class="card-header">
                      <h5 class="card-title mb-0"><%= address.type %></h5>
                    </div>
                    <div class="card-body">
                      <p><strong>Address Type:</strong> <%= address.addressType %></p>
                      <p><strong>Name:</strong> <%= address.name %></p>
                      <p><strong>City:</strong> <%= address.city %></p>
                      <p><strong>Landmark:</strong> <%= address.landMark %></p>
                      <p><strong>State:</strong> <%= address.state %></p>
                      <p><strong>Pincode:</strong> <%= address.pincode %></p>
                      <p><strong>Phone:</strong> <%= address.phone %></p>
                      <p><strong>Alternate Phone:</strong> <%= address.altPhone %></p>
                      <a href="/delete-address/?id=<%= address._id %>" class="btn btn-danger btn-sm me-2">Delete</a>
                      <a href="/edit-address/?id=<%= address._id %>" class="btn btn-primary btn-sm">Edit</a>
                    </div>
                  </div>
                </div>
              <% }) %>
            <% } else { %>
              <div class="col-md-6 mb-3">
                <div class="card">
                  <div class="card-header">
                    <h5 class="card-title mb-0">Billing Address</h5>
                  </div>
                  <div class="card-body">
                    <p class="card-text">No address available.</p>
                  </div>
                </div>
              </div>
            <% } %>
          </div>
          <a href="/add-address" class="btn btn-primary mt-3">Add Address</a>
        </div>
        <div class="tab-pane fade" id="account-detail" role="tabpanel" aria-labelledby="account-detail-tab">
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Account Details</h5>
            </div>
            <div class="card-body">
              <p class="card-text">Already have an account? <a href="page-login-register.html">Log in instead!</a></p>
              <% if (successmessage) { %>
                <div class="alert alert-success" role="alert">
                  <%= successmessage %>
                </div>
              <% } %>
              <form id="userProfileForm" onsubmit="return validateForm(event);" method="post" action="/userprofile?id=<%= user._id %>">
                <div class="mb-3">
                  <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" id="name" name="name" value="<%=user.username %>" required>
                  <div id="nameError" class="form-text text-danger"></div>
                </div>
                <div class="mb-3">
                  <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
                  <input type="email" class="form-control" id="email" name="email" value="<%=user.email%>" readonly required>
                  <div id="emailError" class="form-text text-danger"></div>
                </div>
                <div class="mb-3">
                  <label for="phone" class="form-label">Phone no. <span class="text-danger">*</span></label>
                  <input type="tel" class="form-control" id="phone" name="phone" value="<%=user.phone%>" required>
                  <div id="phoneError" class="form-text text-danger"></div>
                </div>
                <button type="submit" class="btn btn-primary" name="submitbutton">Save</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  function confirmCancelation(orderId, paymentMethod) {
    if (paymentMethod === 'Online') {
      Swal.fire({
        title: 'Are you sure?',
        text: "The amount will be credited to your wallet upon cancellation.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, cancel it!'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = `/order-cancel?id=${orderId}`;
        }
      });
    } else {
      Swal.fire({
        title: 'Order Canceled',
        text: "Your order has been successfully canceled.",
        icon: 'success',
        confirmButtonColor: '#3085d6',
      }).then(() => {
        window.location.href = `/order-cancel?id=${orderId}`;
      });
    }
  }

  function confirmReturn(orderId, paymentMethod) {
    try {
        Swal.fire({
            title: 'Order Return',
            text: 'Are you sure you want to return the order?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, return it!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/order-return?id=${orderId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: 'Return Successful',
                            text: 'The amount has been refunded to your wallet.',
                            icon: 'success',
                            confirmButtonColor: '#3085d6'
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Return Failed',
                            text: data.message || 'There was an issue processing your return.',
                            icon: 'error',
                            confirmButtonColor: '#3085d6'
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Error',
                        text: 'An error occurred while processing your return.',
                        icon: 'error',
                        confirmButtonColor: '#3085d6'
                    });
                    console.error("Error in return request:", error);
                });
            }
        });
    } catch (error) {
        console.error("Error in confirmReturn:", error);
    }
}


  function validateForm(event) {
    event.preventDefault();

    document.getElementById('nameError').innerText = '';
    document.getElementById('emailError').innerText = '';
    document.getElementById('phoneError').innerText = '';

    const name = document.querySelector('input[name="name"]').value;
    const email = document.querySelector('input[name="email"]').value;
    const phone = document.querySelector('input[name="phone"]').value;

    let isValid = true;

    if (!name || name.length < 2) {
      document.getElementById('nameError').innerText = 'Name must be at least two characters long';
      isValid = false;
    }

    const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!email || !emailPattern.test(email)) {
      document.getElementById('emailError').innerText = 'Please enter a valid email address.';
      isValid = false;
    }

    const phonePattern = /^\+?[0-9\s]{7,15}$/;
    if (!phone || !phonePattern.test(phone)) {
      document.getElementById('phoneError').innerText = 'Please enter a valid phone number.';
      isValid = false;
    }

    if (isValid) {
      document.getElementById('userProfileForm').submit();
    }
  }
</script>

<%- include('../partials/user/footer') %>