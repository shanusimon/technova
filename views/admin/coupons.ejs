<%- include("../../views/partials/admin/header") %>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <div class="container mt-5">
    <h2 class="text-center mb-4">Coupon Management</h2>

    <!-- Add Coupon Button -->
    <div class="text-right mb-3">
      <button class="btn btn-primary" data-toggle="modal" data-target="#addCouponModal">
        <a style="color: white;" href="/admin/add-coupons">Add Coupons</a>
      </button>
    </div>

    <!-- Coupon Table -->
    <table class="table table-bordered table-hover">
      <thead class="thead-dark">
        <tr>
          <th>Coupon Code</th>
          <th>Discount Percentage</th>
          <th>Minimum Amount</th>
          <th>Maximum Amount</th>
          <th>Created On</th>
          <th>End On</th>
          <th>Is Active</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% data.forEach(element=> { %>
          <tr>
            <td>
              <%= element.code %>
            </td>
            <td>
              <%= element.price %>
            </td>
            <td>
              <%= element.minimumAmount %>
            </td>
            <td>
              <%= element.maximumAmount %>
            </td>
            <td>
              <%= element.createdOn.toLocaleString() %>
            </td>
            <td>
              <%= element.endOn.toLocaleString() %>
            </td>
            <td>
              <%= element.isActive ? 'Yes' : 'No' %>
            </td>
            <td>
              <button class="btn btn-danger" onclick="confirmDelete('<%=element._id%>')">Delete</button>

            </td>
          </tr>
          <% }); %>
      </tbody>
    </table>
    <!-- Pagination -->
    <% if (totalPages > 1) { %>
      <nav>
        <ul class="pagination justify-content-center">
          <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="?page=<%= currentPage - 1 %>">Previous</a>
          </li>

          <% for (let i=1; i <=totalPages; i++) { %>
            <li class="page-item <%= currentPage === i ? 'active' : '' %>">
              <a class="page-link" href="?page=<%= i %>">
                <%= i %>
              </a>
            </li>
            <% } %>

              <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                <a class="page-link" href="?page=<%= currentPage + 1 %>">Next</a>
              </li>
        </ul>
      </nav>
      <% } %>
        <br>
        <br>
        <br>
        <br>
  </div>
  <script>
    async function confirmDelete(couponId) {
      try {
        Swal.fire({
          title: 'Are you sure?',
          text: 'Do you really want to delete this coupon?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, delete it!',
          cancelButtonText: 'No, cancel!',
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(`/admin/delete?id=${couponId}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
            }).then(response => {
              if (response.ok) {
                Swal.fire({
                  title: "Coupon Deleted Successfully",
                  icon: 'success'
                }).then(() => {
                  window.location.reload();
                });
              } else {
                Swal.fire('Error!', 'There was a problem deleting the coupon.', 'error');
              }
            });
          }
        });
      } catch (error) {
        console.error("Error in deleting coupon", error);
        Swal.fire('Error!', 'There was a network error.', 'error');
      }
    }

  </script>

  <%- include("../../views/partials/admin/footer") %>