<%- include("../../views/partials/admin/header") %>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <section class="content-main">
        <div class="content-header">
            <div>
                <h2 class="content-title card-title">Order List</h2>
            </div>
            <div>
                <input type="text" placeholder="Search order ID" class="form-control bg-white">
            </div>
        </div>
        <div class="card mb-4">
            <header class="card-header">
                <form id="filterForm" method="get" class="row gx-3">
                    <div class="col-lg-4 col-md-6 me-auto">
                        <input type="text" name="search" value="<%= search || '' %>"
                            placeholder="Search Order ID or Product" class="form-control">
                    </div>
                    <div class="col-lg-2 col-6 col-md-3">
                        <select class="form-select" name="status"
                            onchange="document.getElementById('filterForm').submit()">
                            <option value="">All Status</option>
                            <option value="Pending" <%=status==='Pending' ? 'selected' : '' %>>Pending</option>
                            <option value="Processing" <%=status==='Processing' ? 'selected' : '' %>>Processing</option>
                            <option value="Shipped" <%=status==='Shipped' ? 'selected' : '' %>>Shipped</option>
                            <option value="Delivered" <%=status==='Delivered' ? 'selected' : '' %>>Delivered</option>
                            <option value="Cancelled" <%=status==='Cancelled' ? 'selected' : '' %>>Cancelled</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-6 col-md-3">
                        <select class="form-select" name="limit"
                            onchange="document.getElementById('filterForm').submit()">
                            <option value="7" <%=limit==7 ? 'selected' : '' %>>Show 7</option>
                            <option value="20" <%=limit==20 ? 'selected' : '' %>>Show 20</option>
                            <option value="30" <%=limit==30 ? 'selected' : '' %>>Show 30</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3">
                        <button type="submit" class="btn btn-primary">Search</button>
                    </div>
                </form>
            </header>

            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#ID</th>
                                <th scope="col">Product Name</th>
                                <th scope="col">Date</th>
                                <th scope="col">Name of User</th>
                                <th scope="col">Total</th>
                                <th scope="col">Status</th>
                                <th scope="col">Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% orders.forEach(order=> { %>
                                <tr>
                                    <td>
                                        <%= order._id %>
                                    </td>
                                    <td>
                                        <% order.orderedItems.forEach(item=> { %>
                                            <%= item.product.productName %><br>
                                                <% }) %>
                                    </td>
                                    <td>
                                        <%= order.createdOn.toDateString() %>
                                    </td>
                                    <td>
                                        <%= order.user ? order.user.username : 'Unknown User' %>
                                    </td>
                                    <td>
                                        <%= order.totalPrice %>
                                    </td>
                                    <td>
                                        <select name="status" data-current-status="<%= order.status %>"
                                            onchange="updateStatus('<%= order._id %>', this)">
                                            <option value="Pending" <%=order.status==='Pending' ? 'selected' : '' %>
                                                >Pending</option>
                                            <option value="Processing" <%=order.status==='Processing' ? 'selected' : ''
                                                %>>Processing</option>
                                            <option value="Shipped" <%=order.status==='Shipped' ? 'selected' : '' %>
                                                >Shipped</option>
                                            <option value="Delivered" <%=order.status==='Delivered' ? 'selected' : '' %>
                                                >Delivered</option>
                                            <option value="Cancelled" <%=order.status==='Cancelled' ? 'selected' : '' %>
                                                >Cancelled</option>
                                        </select>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-info"
                                            onclick="showOrderDetails('<%- encodeURIComponent(JSON.stringify(order)) %>')">
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Pagination Section -->
        <div class="pagination-area mt-15 mb-50">
            <nav aria-label="Page navigation example">
                <ul class="pagination justify-content-start">
                    <% if (currentPage> 1) { %>
                        <li class="page-item">
                            <a class="page-link" href="?page=<%= currentPage - 1 %>&limit=<%= limit %>">Previous</a>
                        </li>
                        <% } %>
                            <% for (let i=1; i <=totalPages; i++) { %>
                                <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                    <a class="page-link" href="?page=<%= i %>&limit=<%= limit %>">
                                        <%= i %>
                                    </a>
                                </li>
                                <% } %>
                                    <% if (currentPage < totalPages) { %>
                                        <li class="page-item">
                                            <a class="page-link"
                                                href="?page=<%= currentPage + 1 %>&limit=<%= limit %>">Next</a>
                                        </li>
                                        <% } %>
                </ul>
            </nav>
        </div>
    </section>
    <%- include("../../views/partials/admin/footer") %>

        <script>
            const statusHierarchy = {
                "Pending": 1,
                "Processing": 2,
                "Shipped": 3,
                "Delivered": 4,
                "Cancelled": 5,
                "Return Request": 6,
                "Returned": 7
            };

            async function updateStatus(orderId, selectElement) {
                const currentStatus = selectElement.getAttribute("data-current-status");
                const newStatus = selectElement.value;

                const currentRank = statusHierarchy[currentStatus];
                const newRank = statusHierarchy[newStatus];

                if (newRank < currentRank) {
                    Swal.fire({
                        title: "Invalid Status Change",
                        text: `You cannot move from "${currentStatus}" to "${newStatus}".`,
                        icon: "error",
                        confirmButtonText: "OK"
                    });
                    selectElement.value = currentStatus;
                    return;
                }

                try {
                    const response = await fetch(`/admin/update-status/${orderId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        Swal.fire({
                            title: 'Success',
                            text: 'Order Status Updated Successfully',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        });
                        selectElement.setAttribute("data-current-status", newStatus);
                    } else {
                        Swal.fire({
                            title: "Failed",
                            text: "Order Status Update Failed",
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                        selectElement.value = currentStatus;
                    }
                } catch (error) {
                    console.error("Error:", error);
                }
            }
            function showOrderDetails(orderJson) {
                console.log(orderJson)
                let order;
                try {
                    order = JSON.parse(decodeURIComponent(orderJson));
                } catch (err) {
                    console.error("Invalid order data:", err);
                    return;
                }

                // Items list
                let itemsHtml = order.orderedItems.map(item => `
        <li>
            <strong>${item.product?.productName || 'Unknown Product'}</strong>
            — Qty: ${item.quantity}
            — Price: ₹${item.price}
        </li>
    `).join("");

                // Address details
                let addressHtml = `
        <p><strong>Name:</strong> ${order.address?.name}</p>
        <p><strong>Type:</strong> ${order.address?.addressType}</p>
        <p><strong>City:</strong> ${order.address?.city}</p>
        <p><strong>Landmark:</strong> ${order.address?.landMark}</p>
        <p><strong>State:</strong> ${order.address?.state}</p>
        <p><strong>Pincode:</strong> ${order.address?.pincode}</p>
        <p><strong>Phone:</strong> ${order.address?.phone}</p>
        <p><strong>Alt Phone:</strong> ${order.address?.altPhone}</p>
    `;

                Swal.fire({
                    title: `Order #${order.orderId}`,
                    html: `
            <p><strong>Date:</strong> ${new Date(order.createdOn).toLocaleString()}</p>
            <p><strong>Status:</strong> ${order.status}</p>
            <p><strong>Payment Method:</strong> ${order.paymentMethod}</p>
            <p><strong>Payment Status:</strong> ${order.paymentStatus}</p>
            <hr>
            <h4>Items:</h4>
            <ul>${itemsHtml}</ul>
            <hr>
            <h4>Address:</h4>
            ${addressHtml}
            <hr>
            <p><strong>Total Price:</strong> ₹${order.totalPrice}</p>
            <p><strong>Discount:</strong> ₹${order.discount}</p>
            <p><strong>Delivery Charge:</strong> ₹${order.deliveryCharge}</p>
            <p><strong>Final Amount:</strong> ₹${order.finalAmount}</p>
            ${order.couponApplied ? `<p><strong>Coupon Code:</strong> ${order.couponCode}</p>` : ""}
        `,
                    width: 650,
                    confirmButtonText: "Close"
                });
            }
        </script>