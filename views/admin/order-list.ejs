<%- include("../../views/partials/admin/header") %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<section class="content-main">
    <div class="content-header">
        <div>
            <h2 class="content-title card-title">Order List</h2>
            <p>Lorem ipsum dolor sit amet.</p>
        </div>
        <div>
            <input type="text" placeholder="Search order ID" class="form-control bg-white">
        </div>
    </div>
    <div class="card mb-4">
        <header class="card-header">
            <div class="row gx-3">
                <div class="col-lg-4 col-md-6 me-auto">
                    <input type="text" placeholder="Search..." class="form-control">
                </div>
                <div class="col-lg-2 col-6 col-md-3">
                    <select class="form-select">
                        <option>Status</option>
                        <option>Active</option>
                        <option>Disabled</option>
                        <option>Show all</option>
                    </select>
                </div>
                <div class="col-lg-2 col-6 col-md-3">
                    <select class="form-select">
                        <option>Show 20</option>
                        <option>Show 30</option>
                        <option>Show 40</option>
                    </select>
                </div>
            </div>
        </header>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>#ID</th>
                            <th scope="col">Product Name</th>
                            <th scope="col">Date</th>
                            <th scope="col">Name of User</th>
                            <th scope="col">Total</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% orders.forEach(order => { %>
                            <tr>
                                <td><%= order._id %></td>
                                <td>
                                    <% order.orderedItems.forEach(item => { %>
                                        <%= item.product.productName %><br> 
                                    <% }) %>
                                </td>
                                <td><%= order.createdOn.toDateString() %></td>
                                <td><%= order.user.username %></td> 
                                <td><%= order.totalPrice %></td> 
                                <td>
                                    <select name="status" onchange="updateStatus('<%= order._id %>', this.value)">
                                        <option value="Pending" <%= order.status === 'Pending' ? 'selected' : '' %>>Pending</option>
                                        <option value="Processing" <%= order.status === 'Processing' ? 'selected' : '' %>>Processing</option>
                                        <option value="Shipped" <%= order.status === 'Shipped' ? 'selected' : '' %>>Shipped</option>
                                        <option value="Delivered" <%= order.status === 'Delivered' ? 'selected' : '' %>>Delivered</option>
                                        <option value="Cancelled" <%= order.status === 'Cancelled' ? 'selected' : '' %>>Cancelled</option>
                                        <option value="Return Request" <%= order.status === 'Return Request' ? 'selected' : '' %>>Return Request</option>
                                        <option value="Returned" <%= order.status === 'Returned' ? 'selected' : '' %>>Returned</option>
                                    </select>
                                </td>                                
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div> <!-- table-responsive //end -->
        </div> <!-- card-body end// -->
    </div> <!-- card end// -->
    <div class="pagination-area mt-15 mb-50">
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-start">
                <li class="page-item active"><a class="page-link" href="#">01</a></li>
                <li class="page-item"><a class="page-link" href="#">02</a></li>
                <li class="page-item"><a class="page-link" href="#">03</a></li>
                <li class="page-item"><a class="page-link dot" href="#">...</a></li>
                <li class="page-item"><a class="page-link" href="#">16</a></li>
                <li class="page-item"><a class="page-link" href="#"><i class="material-icons md-chevron_right"></i></a></li>
            </ul>
        </nav>
    </div>
</section> <!-- content-main end// -->
<%- include("../../views/partials/admin/footer") %> 

<script>
    async function updateStatus(orderId, status) {
        try {
            const response = await fetch(`/admin/update-status/${orderId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status })
            });

            if (response.ok) {
                Swal.fire({
                    title:'Success',
                    text:'Order Status Updated Sucessfully',
                    icon:'success',
                    confirmButtonText: 'OK'
                })
                console.log("Status updated successfully");
            } else {
                Swal.fire({
                    title:"Failed",
                    text:"Order Status Updating Failed",
                    icon:'error',
                    confirmButtonText: 'OK'
                })
                console.error("Failed to update status");
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }
</script>
